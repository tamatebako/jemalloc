name: CI

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '**.adoc'
      - 'ChangeLog'
      - 'COPYING'
      - 'doc/**'
      - 'doc_internal/**'
  pull_request:
    paths-ignore:
      - '**.md'
      - '**.adoc'
      - 'ChangeLog'
      - 'COPYING'
      - 'doc/**'
      - 'doc_internal/**'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Level 1: Basic platform builds
  basic-platforms:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux essential
          - name: Linux x64 gcc
            os: ubuntu-24.04
            cc: gcc
            cxx: g++
          - name: Linux x64 clang
            os: ubuntu-24.04
            cc: clang
            cxx: clang++
          - name: Linux ARM64 gcc
            os: ubuntu-24.04-arm
            cc: gcc
            cxx: g++
          - name: Linux ARM64 clang
            os: ubuntu-24.04-arm
            cc: clang
            cxx: clang++

          # Windows MinGW (autoconf/configure based)
          - name: Windows x64 MinGW
            os: windows-2022
            cc: gcc
            cxx: g++
            mingw: MINGW64
          - name: Windows x86 MinGW
            os: windows-2022
            cc: gcc
            cxx: g++
            mingw: MINGW32

          # Windows MSVC (autoconf+make with cl.exe, like Travis CI)
          - name: Windows x64 MSVC
            os: windows-2022
            cc: cl
            cxx: cl
            msvc: true
            msvc_arch: x64
          - name: Windows x86 MSVC
            os: windows-2022
            cc: cl
            cxx: cl
            msvc: true
            msvc_arch: x86

          # Windows ARM64 MSVC (autoconf+make with cl.exe, like Travis CI)
          - name: Windows ARM64 MSVC
            os: windows-11-arm
            cc: cl
            cxx: cl
            msvc: true
            msvc_arch: arm64

          # macOS
          - name: macOS Intel
            os: macos-15-intel
            cc: clang
            cxx: clang++
          - name: macOS ARM64
            os: macos-15
            cc: clang
            cxx: clang++

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Linux setup
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      # Windows MSVC.setup (autoconf+make with cl.exe via PATH inheritance)
      - name: Setup MSVC
        if: runner.os == 'Windows' && matrix.msvc
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Setup MSYS2 for MSVC
        if: runner.os == 'Windows' && matrix.msvc
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msvc_arch == 'x86' && 'MINGW32' || (matrix.msvc_arch == 'arm64' && 'CLANGARM64' || 'MINGW64') }}
          update: false
          path-type: inherit
          install: >-
            cmake
            ninja
            make

      # Windows MinGW setup (autoconf/configure)
      - name: Setup_MSYS2 MinGW
        if: runner.os == 'Windows' && matrix.mingw != ''
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.mingw }}
          update: true
          install: >-
            cmake
            ninja
            make
            ${{ matrix.mingw == 'MINGW64' && 'mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils' || 'mingw-w64-i686-gcc mingw-w64-i686-binutils' }}

      # macOS setup
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          # Install cmake if not present
          if ! which cmake > /dev/null 2>&1; then
            brew install cmake ninja
          fi

      # Configure - Linux/macOS
      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          echo "==> Configure with CMake (CC=$CC)"
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "==> Build"
          cmake --build build
          echo "==> Install"
          cmake --install build --prefix $PWD/install

      - name: Test (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "==> Run tests"
          cd build
          ctest --output-on-failure

      # Windows MinGW build
      - name: Build (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        env:
          CC: gcc
          CXX: g++
        run: |
          echo "==> Configure with CMake"
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          echo "==> Build"
          cmake --build build
          echo "==> Install"
          cmake --install build --prefix $PWD/install

      - name: Test (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        run: |
          echo "==> Run tests"
          cd build
          ctest --output-on-failure

      # Windows MSVC: Use CMake native
      - name: Build (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        run: |
          echo "==> Configure with CMake"
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          echo "==> Build"
          cmake --build build --config Release
          echo "==> Install"
          cmake --install build --config Release --prefix ${{ github.workspace }}/install

      - name: Test (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        run: |
          echo "==> Run tests"
          cd build
          ctest -C Release --output-on-failure

  # FreeBSD
  freebsd:
    name: FreeBSD ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ['14.1', '15.0']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: ${{ matrix.version }}
          usesh: true
          prepare: pkg install -y cmake gmake gcc ninja
          run: |
            set -e
            echo "==> Configure with CMake"
            cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

            echo "==> Build"
            JFLAG=$(sysctl -n kern.smp.cpus)
            cmake --build build -j${JFLAG}

            echo "==> Install"
            cmake --install build --prefix $PWD/install

            echo "==> Run tests"
            cd build
            ctest --output-on-failure

  # Level 1: Alpine Linux (native musl libc)
  alpine-musl:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    container: alpine:3.20
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Alpine Linux x64 gcc
            os: ubuntu-24.04
            cc: gcc
            cxx: g++
          - name: Alpine Linux x64 clang
            os: ubuntu-24.04
            cc: clang
            cxx: clang++
          - name: Alpine Linux ARM64 gcc
            os: ubuntu-24.04-arm
            cc: gcc
            cxx: g++

    steps:
      - name: Checkout (Alpine x64)
        if: matrix.os == 'ubuntu-24.04'
        uses: actions/checkout@v4

      - name: Checkout (Alpine ARM64)
        if: matrix.os == 'ubuntu-24.04-arm'
        uses: taiki-e/checkout-action@v1

      - name: Install dependencies
        run: |
          apk update
          apk add cmake make gcc g++ clang musl-dev linux-headers ninja

      - name: Build and test with CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          # Translate configure flags to CMake options
          CMAKE_FLAGS=""

          # Build type
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-debug"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Debug"
          else
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Release"
          fi

          # Feature flags
          echo "${{ matrix.flags }}" | grep -q -- "--enable-prof" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_PROF=ON"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-stats" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_STATS=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-libdl" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LIBDL=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--enable-opt-safety-checks" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_OPT_SAFETY_CHECKS=ON"

          # Page size
          if echo "${{ matrix.flags }}" | grep -q -- "--with-lg-page=16"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LG_PAGE=16"
          fi

          # Malloc conf (extract value after =)
          if echo "${{ matrix.flags }}" | grep -q -- "--with-malloc-conf="; then
            MALLOC_CONF=$(echo "${{ matrix.flags }}" | grep -o -- '--with-malloc-conf=[^ ]*' | cut -d= -f2-)
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_CONFIG_MALLOC_CONF=$MALLOC_CONF"
          fi

          echo "==> Configure with CMake (CC=$CC, FLAGS=${{ matrix.flags }})"
          cmake -B build -G Ninja $CMAKE_FLAGS

          echo "==> Build"
          cmake --build build

          echo "==> Install"
          cmake --install build --prefix $PWD/install

          echo "==> Test"
          cd build
          ctest --output-on-failure

  # Level 2: Comprehensive configure flag testing (runs after Linux succeeds)
  linux-configure-flags:
    name: Linux flags - ${{ matrix.compiler }} ${{ matrix.flags }}
    runs-on: ubuntu-24.04
    needs: [basic-platforms, test-cmake-builds, test-vcpkg-integration]
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        flags:
          # Single flag options
          - --enable-debug
          - --enable-prof
          - --disable-stats
          - --disable-libdl
          - --enable-opt-safety-checks
          - --with-lg-page=16
          - --enable-prof --enable-prof-frameptr
          - --with-malloc-conf=tcache:false
          - --with-malloc-conf=dss:primary
          - --with-malloc-conf=percpu_arena:percpu
          - --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-debug
          - --enable-debug --enable-prof
          - --enable-debug --disable-stats
          - --enable-debug --disable-libdl
          - --enable-debug --enable-opt-safety-checks
          - --enable-debug --with-lg-page=16
          - --enable-debug --enable-prof --enable-prof-frameptr
          - --enable-debug --with-malloc-conf=tcache:false
          - --enable-debug --with-malloc-conf=dss:primary
          - --enable-debug --with-malloc-conf=percpu_arena:percpu
          - --enable-debug --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-prof
          - --enable-prof --disable-stats
          - --enable-prof --disable-libdl
          - --enable-prof --enable-opt-safety-checks
          - --enable-prof --with-lg-page=16
          - --enable-prof --with-malloc-conf=tcache:false
          - --enable-prof --with-malloc-conf=dss:primary
          - --enable-prof --with-malloc-conf=percpu_arena:percpu
          - --enable-prof --with-malloc-conf=background_thread:true
          # Two-option combinations with --disable-stats
          - --disable-stats --disable-libdl
          - --disable-stats --enable-opt-safety-checks
          - --disable-stats --with-lg-page=16
          - --disable-stats --enable-prof --enable-prof-frameptr
          - --disable-stats --with-malloc-conf=tcache:false
          - --disable-stats --with-malloc-conf=dss:primary
          - --disable-stats --with-malloc-conf=percpu_arena:percpu
          - --disable-stats --with-malloc-conf=background_thread:true
          # Two-option combinations with --disable-libdl
          - --disable-libdl --enable-opt-safety-checks
          - --disable-libdl --with-lg-page=16
          - --disable-libdl --enable-prof --enable-prof-frameptr
          - --disable-libdl --with-malloc-conf=tcache:false
          - --disable-libdl --with-malloc-conf=dss:primary
          - --disable-libdl --with-malloc-conf=percpu_arena:percpu
          - --disable-libdl --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-opt-safety-checks
          - --enable-opt-safety-checks --with-lg-page=16
          - --enable-opt-safety-checks --enable-prof --enable-prof-frameptr
          - --enable-opt-safety-checks --with-malloc-conf=tcache:false
          - --enable-opt-safety-checks --with-malloc-conf=dss:primary
          - --enable-opt-safety-checks --with-malloc-conf=percpu_arena:percpu
          - --enable-opt-safety-checks --with-malloc-conf=background_thread:true
          # Two-option combinations with --with-lg-page=16
          - --with-lg-page=16 --enable-prof --enable-prof-frameptr
          - --with-lg-page=16 --with-malloc-conf=tcache:false
          - --with-lg-page=16 --with-malloc-conf=dss:primary
          - --with-lg-page=16 --with-malloc-conf=percpu_arena:percpu
          - --with-lg-page=16 --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-prof --enable-prof-frameptr
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=tcache:false
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=dss:primary
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=percpu_arena:percpu
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=background_thread:true
          # Multiple malloc-conf options
          - --with-malloc-conf=tcache:false,dss:primary
          - --with-malloc-conf=tcache:false,percpu_arena:percpu
          - --with-malloc-conf=tcache:false,background_thread:true
          - --with-malloc-conf=dss:primary,percpu_arena:percpu
          - --with-malloc-conf=dss:primary,background_thread:true
          - --with-malloc-conf=percpu_arena:percpu,background_thread:true
        exclude:
          # Clang doesn't need all the same combinations, reduce matrix
          - compiler: clang
            flags: --enable-debug --disable-stats
          - compiler: clang
            flags: --enable-debug --disable-libdl
          - compiler: clang
            flags: --enable-debug --enable-opt-safety-checks
          - compiler: clang
            flags: --enable-debug --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-debug --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-prof --disable-stats
          - compiler: clang
            flags: --enable-prof --disable-libdl
          - compiler: clang
            flags: --enable-prof --enable-opt-safety-checks
          - compiler: clang
            flags: --enable-prof --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-prof --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-stats --disable-libdl
          - compiler: clang
            flags: --disable-stats --enable-opt-safety-checks
          - compiler: clang
            flags: --disable-stats --with-lg-page=16
          - compiler: clang
            flags: --disable-stats --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --disable-libdl --enable-opt-safety-checks
          - compiler: clang
            flags: --disable-libdl --with-lg-page=16
          - compiler: clang
            flags: --disable-libdl --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --enable-opt-safety-checks --with-lg-page=16
          - compiler: clang
            flags: --enable-opt-safety-checks --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --with-lg-page=16 --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,dss:primary
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,percpu_arena:percpu
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=dss:primary,percpu_arena:percpu
          - compiler: clang
            flags: --with-malloc-conf=dss:primary,background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=percpu_arena:percpu,background_thread:true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Build and test
        env:
          CC: ${{ matrix.compiler == 'clang' && 'clang' || 'gcc' }}
          CXX: ${{ matrix.compiler == 'clang' && 'clang++' || 'g++' }}
        run: |
          # Translate configure flags to CMake options
          CMAKE_FLAGS=""

          # Build type
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-debug"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Debug"
          else
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Release"
          fi

          # Feature flags
          echo "${{ matrix.flags }}" | grep -q -- "--enable-prof" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_PROF=ON"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-stats" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_STATS=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-libdl" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LIBDL=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--enable-opt-safety-checks" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_OPT_SAFETY_CHECKS=ON"

          # Page size
          if echo "${{ matrix.flags }}" | grep -q -- "--with-lg-page=16"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LG_PAGE=16"
          fi

          # Malloc conf (extract value after =)
          if echo "${{ matrix.flags }}" | grep -q -- "--with-malloc-conf="; then
            MALLOC_CONF=$(echo "${{ matrix.flags }}" | grep -o -- '--with-malloc-conf=[^ ]*' | cut -d= -f2-)
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_CONFIG_MALLOC_CONF=$MALLOC_CONF"
          fi

          echo "==> Configure with CMake (CC=$CC, FLAGS=${{ matrix.flags }})"
          cmake -B build -G Ninja $CMAKE_FLAGS

          echo "==> Build"
          cmake --build build

          echo "==> Install"
          cmake --install build --prefix $PWD/install

          echo "==> Test"
          cd build
          ctest --output-on-failure

  # Level 2: 32-bit builds (after Linux succeeds)
  linux-32bit:
    name: Linux 32-bit - gcc ${{ matrix.name }}
    runs-on: ubuntu-24.04
    needs: [basic-platforms, test-cmake-builds, test-vcpkg-integration]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ''
          - name: debug
            flags: --enable-debug
          - name: prof
            flags: --enable-prof
          - name: disable-stats
            flags: --disable-stats
          - name: disable-libdl
            flags: --disable-libdl
          - name: opt-safety-checks
            flags: --enable-opt-safety-checks
          - name: lg-page-16
            flags: --with-lg-page=16
          - name: prof-frameptr
            flags: --enable-prof --enable-prof-frameptr
          - name: tcache-false
            flags: --with-malloc-conf=tcache:false
          - name: dss-primary
            flags: --with-malloc-conf=dss:primary
          - name: percpu-arena
            flags: --with-malloc-conf=percpu_arena:percpu
          - name: background-thread
            flags: --with-malloc-conf=background_thread:true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build gcc-multilib g++-multilib

      - name: Build and test
        run: |
          # Translate configure flags to CMake options
          CMAKE_FLAGS="-DCMAKE_C_FLAGS=-m32 -DCMAKE_CXX_FLAGS=-m32"

          # Build type
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-debug"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Debug"
          else
            CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Release"
          fi

          # Feature flags
          echo "${{ matrix.flags }}" | grep -q -- "--enable-prof" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_PROF=ON"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-stats" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_STATS=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--disable-libdl" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LIBDL=OFF"
          echo "${{ matrix.flags }}" | grep -q -- "--enable-opt-safety-checks" && CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_OPT_SAFETY_CHECKS=ON"

          # Page size
          if echo "${{ matrix.flags }}" | grep -q -- "--with-lg-page=16"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LG_PAGE=16"
          fi

          # Malloc conf
          if echo "${{ matrix.flags }}" | grep -q -- "--with-malloc-conf="; then
            MALLOC_CONF=$(echo "${{ matrix.flags }}" | grep -o -- '--with-malloc-conf=[^ ]*' | cut -d= -f2-)
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_CONFIG_MALLOC_CONF=$MALLOC_CONF"
          fi

          echo "==> Configure with CMake (32-bit)"
          echo "FLAGS: $CMAKE_FLAGS"
          cmake -B build -G Ninja $CMAKE_FLAGS

          echo "==> Build"
          cmake --build build

          echo "==> Install"
          cmake --install build --prefix $PWD/install

          echo "==> Test"
          cd build
          ctest --output-on-failure

  # Special builds
  special-builds:
    name: ${{ matrix.name }}
    runs-on: ubuntu-24.04
    needs: [basic-platforms, test-cmake-builds, test-vcpkg-integration]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Development build
            flags: --enable-debug --disable-cache-oblivious --enable-stats --enable-log --enable-prof
          - name: Experimental smallocx
            flags: --enable-debug --enable-experimental-smallocx --enable-stats --enable-prof

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Build and test
        env:
          CC: gcc
          CXX: g++
        run: |
          # Translate configure flags to CMake options
          CMAKE_FLAGS=""

          # Build type (special builds are typically debug)
          CMAKE_FLAGS="$CMAKE_FLAGS -DCMAKE_BUILD_TYPE=Debug"

          # Development build flags
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-debug"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_DEBUG=ON"
          fi
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-prof"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_PROF=ON"
          fi
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-stats"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_STATS=ON"
          fi
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-log"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_LOG=ON"
          fi
          if echo "${{ matrix.flags }}" | grep -q -- "--disable-cache-oblivious"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_CACHE_OBLIVIOUS=OFF"
          fi
          if echo "${{ matrix.flags }}" | grep -q -- "--enable-experimental-smallocx"; then
            CMAKE_FLAGS="$CMAKE_FLAGS -DJEMALLOC_EXPERIMENTAL_SMALLOCX=ON"
          fi

          echo "==> Configure with CMake"
          echo "FLAGS: $CMAKE_FLAGS"
          cmake -B build -G Ninja $CMAKE_FLAGS

          echo "==> Build"
          cmake --build build

          echo "==> Install"
          cmake --install build --prefix $PWD/install

          echo "==> Test"
          cd build
          ctest --output-on-failure

  # Level 2: Alpine Linux (musl) configure flags
  alpine-configure-flags:
    name: Alpine flags - ${{ matrix.compiler }} ${{ matrix.flags }}
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    container: alpine:3.20
    needs: [alpine-musl, test-cmake-builds, test-vcpkg-integration]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
        compiler: [gcc, clang]
        flags:
          # Essential single flags
          - --enable-debug
          - --enable-prof
          - --disable-stats
          - --disable-libdl
          - --enable-opt-safety-checks
          - --with-lg-page=16
          # Important combinations
          - --enable-debug --enable-prof
          - --enable-debug --disable-stats
          - --enable-prof --disable-stats
          - --disable-stats --disable-libdl
          # Runtime config options
          - --with-malloc-conf=tcache:false
          - --with-malloc-conf=percpu_arena:percpu
          - --with-malloc-conf=background_thread:true
        exclude:
          # Reduce ARM64 matrix size - only test gcc combinations
          - arch: arm64
            compiler: clang

    steps:
      - name: Checkout (Alpine x64)
        if: matrix.arch == 'x64'
        uses: actions/checkout@v4

      - name: Checkout (Alpine ARM64)
        if: matrix.arch == 'arm64'
        uses: taiki-e/checkout-action@v1

      - name: Install dependencies
        run: |
          apk update
          apk add cmake make gcc g++ clang musl-dev linux-headers ninja

      - name: Configure
        env:
          CC: ${{ matrix.compiler == 'clang' && 'clang' || 'gcc' }}
          CXX: ${{ matrix.compiler == 'clang' && 'clang++' || 'g++' }}
          EXTRA_CFLAGS: ${{ matrix.compiler == 'clang' && '-Werror -Wno-array-bounds -Wno-non-literal-null-conversion' || '-Werror -Wno-array-bounds' }}
        run: |
          autoconf
          ./configure --disable-cxx ${{ matrix.flags }}

      - name: Build
        run: make -j$(nproc)

      - name: Build tests
        run: make -j$(nproc) tests

      - name: Run tests
        run: make check

  # Level 1: CMake Integration Testing (runs immediately, part of smoke tests)
  test-cmake-builds:
    name: CMake - ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - name: Linux x64 find_package
            os: ubuntu-24.04
            cmake_preset: find_package
            test_subdirectory: false
            test_fetchcontent: false
          - name: Linux x64 add_subdirectory
            os: ubuntu-24.04
            cmake_preset: add_subdirectory
            test_subdirectory: true
            test_fetchcontent: false
          - name: Linux x64 FetchContent
            os: ubuntu-24.04
            cmake_preset: fetchcontent
            test_subdirectory: false
            test_fetchcontent: true

          # Linux ARM64
          - name: Linux ARM64 find_package
            os: ubuntu-24.04-arm
            cmake_preset: find_package
            test_subdirectory: false

          # macOS ARM64
          - name: macOS ARM64 find_package
            os: macos-15
            cmake_preset: find_package
            test_subdirectory: false
            test_fetchcontent: false
          - name: macOS ARM64 add_subdirectory
            os: macos-15
            cmake_preset: add_subdirectory
            test_subdirectory: true
            test_fetchcontent: false

          # macOS Intel
          - name: macOS Intel find_package
            os: macos-15-intel
            cmake_preset: find_package
            test_subdirectory: false
            test_fetchcontent: false

          # Windows x64 (Native CMake - no MSYS2/autoconf needed!)
          - name: Windows x64 find_package
            os: windows-2022
            cmake_preset: find_package
            test_subdirectory: false
            test_fetchcontent: false

          # Windows ARM64 (Native CMake - no MSYS2/autoconf needed!)
          - name: Windows ARM64 find_package
            os: windows-11-arm
            cmake_preset: find_package
            test_subdirectory: false
            test_fetchcontent: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Install CMake and Ninja using lukka/get-cmake (works on all platforms including ARM64)
      - name: Get CMake and Ninja
        uses: lukka/get-cmake@latest

      # Windows: Setup MSVC compiler
      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ contains(matrix.os, 'arm') && 'arm64' || 'x64' }}

      # Build and install jemalloc with CMake (native - no autoconf needed!)
      - name: Build jemalloc with CMake
        if: matrix.cmake_preset == 'find_package'
        run: |
          echo "==> Building jemalloc with native CMake"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install
          cmake --build build --config Release
          cmake --install build --config Release

      # Test find_package() integration
      - name: Test find_package() integration
        if: matrix.cmake_preset == 'find_package'
        run: |
          echo "==> Testing find_package() integration"
          cd test/cmake/find_package
          cmake -B build -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
          ctest --test-dir build --output-on-failure

      # Test add_subdirectory() integration
      - name: Test add_subdirectory() integration
        if: matrix.test_subdirectory
        run: |
          echo "==> Testing add_subdirectory() integration"
          cd test/cmake/add_subdirectory
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
          ctest --test-dir build --output-on-failure

      # Test FetchContent integration
      - name: Test FetchContent integration
        if: matrix.test_fetchcontent
        run: |
          echo "==> Testing FetchContent integration"
          cd test/cmake/fetchcontent
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
          ctest --test-dir build --output-on-failure

  # Level 1: vcpkg Integration Testing (runs immediately, part of smoke tests)
  test-vcpkg-integration:
    name: vcpkg - ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu x64
            os: ubuntu-24.04
          - name: Linux ARM64
            os: ubuntu-24.04-arm
          - name: Windows x64
            os: windows-2022
          - name: Windows ARM64
            os: windows-11-arm
          - name: macOS Intel
            os: macos-15-intel
          - name: macOS ARM64
            os: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf cmake git curl zip unzip tar

      # macOS dependencies
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          if ! which autoconf > /dev/null 2>&1; then
            brew install autoconf
          fi
          if ! which cmake > /dev/null 2>&1; then
            brew install cmake
          fi

      # Windows dependencies
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: |
          choco install git --installargs 'ADD_CMAKE_TO_PATH=System' -y

      # Windows: Setup MSVC compiler (required for vcpkg builds)
      - name: Setup MSVC
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ contains(matrix.os, 'arm') && 'arm64' || 'x64' }}

      # Setup vcpkg using lukka/run-vcpkg action (recommended best practice)
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'e7b524242c8a5d718a7afa26794c3c19bb8b0c71'
          doNotCache: false

      # Install jemalloc via vcpkg overlay
      - name: Install jemalloc via vcpkg overlay
        shell: bash
        run: |
          echo "==> Installing jemalloc with overlay port"
          if [ "${{ runner.os }}" = "Windows" ]; then
            "$VCPKG_ROOT/vcpkg.exe" install jemalloc --classic --overlay-ports="${{ github.workspace }}/ports"
          else
            "$VCPKG_ROOT/vcpkg" install jemalloc --classic --overlay-ports="${{ github.workspace }}/ports"
          fi

      # Create and test integration project (Windows)
      - name: Test vcpkg integration (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "==> Creating test project"
          New-Item -ItemType Directory -Force -Path vcpkg-test
          Set-Location vcpkg-test

          # Create main.c
          @"
          #include <jemalloc/jemalloc.h>
          #include <stdio.h>

          int main(void) {
              void* ptr = malloc(1024);
              if (!ptr) {
                  fprintf(stderr, "malloc failed\n");
                  return 1;
              }
              printf("jemalloc allocation successful\n");
              free(ptr);
              return 0;
          }
          "@ | Out-File -FilePath main.c -Encoding ASCII

          # Create CMakeLists.txt
          @"
          cmake_minimum_required(VERSION 3.24)
          project(vcpkg_test C)

          find_package(jemalloc CONFIG REQUIRED)

          add_executable(test_app main.c)
          target_link_libraries(test_app PRIVATE jemalloc::jemalloc)

          enable_testing()
          add_test(NAME vcpkg_integration_test COMMAND test_app)
          "@ | Out-File -FilePath CMakeLists.txt -Encoding ASCII

          echo "==> Building test project"
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build --config Release

          echo "==> Running test"
          ctest --test-dir build -C Release --output-on-failure

      # Create and test integration project (Unix)
      - name: Test vcpkg integration (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "==> Creating test project"
          mkdir -p vcpkg-test
          cd vcpkg-test

          # Create main.c
          cat > main.c << 'EOF'
          #include <jemalloc/jemalloc.h>
          #include <stdio.h>

          int main(void) {
              void* ptr = malloc(1024);
              if (!ptr) {
                  fprintf(stderr, "malloc failed\n");
                  return 1;
              }
              printf("jemalloc allocation successful\n");
              free(ptr);
              return 0;
          }
          EOF

          # Create CMakeLists.txt
          cat > CMakeLists.txt << 'EOF'
          cmake_minimum_required(VERSION 3.24)
          project(vcpkg_test C)

          find_package(jemalloc CONFIG REQUIRED)

          add_executable(test_app main.c)
          target_link_libraries(test_app PRIVATE jemalloc::jemalloc)

          enable_testing()
          add_test(NAME vcpkg_integration_test COMMAND test_app)
          EOF

          echo "==> Building test project"
          cmake -B build -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
          cmake --build build

          echo "==> Running test"
          ctest --test-dir build --output-on-failure