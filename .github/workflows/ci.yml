name: CI

on:
  push:
    branches: [master, main, dev]
  pull_request:
    branches: [master, main, dev]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Level 1: Basic platform builds
  basic-platforms:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux essential
          - name: Linux x64 gcc
            os: ubuntu-24.04
            cc: gcc
            cxx: g++
          - name: Linux x64 clang
            os: ubuntu-24.04
            cc: clang
            cxx: clang++
          - name: Linux ARM64 gcc
            os: ubuntu-24.04-arm
            cc: gcc
            cxx: g++

          # Windows MinGW (autoconf/configure based)
          - name: Windows x64 MinGW
            os: windows-2022
            cc: gcc
            cxx: g++
            mingw: MINGW64
          - name: Windows x86 MinGW
            os: windows-2022
            cc: gcc
            cxx: g++
            mingw: MINGW32

          # Windows MSVC (autoconf+make with cl.exe, like Travis CI)
          - name: Windows x64 MSVC
            os: windows-2022
            cc: cl
            cxx: cl
            msvc: true
            msvc_arch: x64
          - name: Windows x86 MSVC
            os: windows-2022
            cc: cl
            cxx: cl
            msvc: true
            msvc_arch: x86

          # macOS
          - name: macOS Intel
            os: macos-13
            cc: clang
            cxx: clang++
          - name: macOS ARM64
            os: macos-14
            cc: clang
            cxx: clang++

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Linux setup
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf

      # Windows MSVC setup (autoconf+make with cl.exe via PATH inheritance)
      - name: Setup MSVC
        if: runner.os == 'Windows' && matrix.msvc
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}

      - name: Setup MSYS2 for MSVC
        if: runner.os == 'Windows' && matrix.msvc
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msvc_arch == 'x86' && 'MINGW32' || 'MINGW64' }}
          update: false
          path-type: inherit
          install: >-
            autoconf
            make

      # Windows MinGW setup (autoconf/configure)
      - name: Setup MSYS2 MinGW
        if: runner.os == 'Windows' && matrix.mingw != ''
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.mingw }}
          update: true
          install: >-
            autoconf
            make
            ${{ matrix.mingw == 'MINGW64' && 'mingw-w64-x86_64-gcc mingw-w64-x86_64-binutils' || 'mingw-w64-i686-gcc mingw-w64-i686-binutils' }}

      # macOS setup
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install autoconf

      # Configure - Linux/macOS
      - name: Configure (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
          EXTRA_CFLAGS: ${{ runner.os == 'Linux' && (contains(matrix.cc, 'clang') && '-Werror -Wno-array-bounds -Wno-unknown-warning-option -Wno-ignored-attributes' || '-Werror -Wno-array-bounds') || '-Werror -Wno-array-bounds -Wno-unknown-warning-option -Wno-ignored-attributes -Wno-deprecated-declarations' }}
        run: |
          echo "==> Autoconf"
          autoconf
          echo "==> Configure with CC=$CC"
          ./configure

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "==> Build"
          make -j$(nproc || sysctl -n hw.ncpu)

      - name: Build tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "==> Build tests"
          make -j$(nproc || sysctl -n hw.ncpu) tests

      - name: Run tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "==> Run tests"
          make check

      # Windows MinGW configure and build
      - name: Configure (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        env:
          CC: gcc
          CXX: g++
          EXTRA_CFLAGS: '-fcommon'
        run: |
          echo "==> Autoconf"
          autoconf
          echo "==> Configure with CC=$CC"
          ./configure

      - name: Build (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        run: |
          echo "==> Build"
          make -j3

      - name: Build tests (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        run: |
          echo "==> Build tests"
          make -j3 tests

      - name: Run tests (Windows MinGW)
        if: runner.os == 'Windows' && matrix.mingw != ''
        shell: msys2 {0}
        run: |
          echo "==> Run tests"
          make -k check

      # Windows MSVC: Use autoconf+make with cl.exe (like Travis CI)
      - name: Configure (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        shell: msys2 {0}
        env:
          CC: cl
          CXX: cl
        run: |
          echo "==> Autoconf"
          autoconf
          echo "==> Configure with CC=$CC CXX=$CXX"
          ./configure

      - name: Build (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        shell: msys2 {0}
        run: |
          echo "==> Build"
          make -j3

      - name: Build tests (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        shell: msys2 {0}
        run: |
          echo "==> Build tests"
          make -j3 tests

      - name: Run tests (Windows MSVC)
        if: runner.os == 'Windows' && matrix.msvc
        shell: msys2 {0}
        run: |
          echo "==> Adding lib/ to PATH for DLL loading"
          export PATH="$(pwd)/lib:$PATH"
          echo "==> Run tests"
          make -k check

  # FreeBSD
  freebsd:
    name: FreeBSD ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        version: ['14.1', '15.0']

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test on FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: ${{ matrix.version }}
          usesh: true
          prepare: pkg install -y autoconf gmake gcc
          run: |
            set -e
            echo "==> Configure"
            autoconf
            ./configure --with-jemalloc-prefix=ci_

            echo "==> Build"
            JFLAG=$(sysctl -n kern.smp.cpus)
            gmake -j${JFLAG}

            echo "==> Build tests"
            gmake -j${JFLAG} tests

            echo "==> Run tests"
            gmake check

  # Level 2: Comprehensive configure flag testing (runs after Linux succeeds)
  linux-configure-flags:
    name: Linux flags - ${{ matrix.compiler }} ${{ matrix.flags }}
    runs-on: ubuntu-24.04
    needs: basic-platforms
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        flags:
          # Single flag options
          - --enable-debug
          - --enable-prof
          - --disable-stats
          - --disable-libdl
          - --enable-opt-safety-checks
          - --with-lg-page=16
          - --enable-prof --enable-prof-frameptr
          - --with-malloc-conf=tcache:false
          - --with-malloc-conf=dss:primary
          - --with-malloc-conf=percpu_arena:percpu
          - --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-debug
          - --enable-debug --enable-prof
          - --enable-debug --disable-stats
          - --enable-debug --disable-libdl
          - --enable-debug --enable-opt-safety-checks
          - --enable-debug --with-lg-page=16
          - --enable-debug --enable-prof --enable-prof-frameptr
          - --enable-debug --with-malloc-conf=tcache:false
          - --enable-debug --with-malloc-conf=dss:primary
          - --enable-debug --with-malloc-conf=percpu_arena:percpu
          - --enable-debug --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-prof
          - --enable-prof --disable-stats
          - --enable-prof --disable-libdl
          - --enable-prof --enable-opt-safety-checks
          - --enable-prof --with-lg-page=16
          - --enable-prof --with-malloc-conf=tcache:false
          - --enable-prof --with-malloc-conf=dss:primary
          - --enable-prof --with-malloc-conf=percpu_arena:percpu
          - --enable-prof --with-malloc-conf=background_thread:true
          # Two-option combinations with --disable-stats
          - --disable-stats --disable-libdl
          - --disable-stats --enable-opt-safety-checks
          - --disable-stats --with-lg-page=16
          - --disable-stats --enable-prof --enable-prof-frameptr
          - --disable-stats --with-malloc-conf=tcache:false
          - --disable-stats --with-malloc-conf=dss:primary
          - --disable-stats --with-malloc-conf=percpu_arena:percpu
          - --disable-stats --with-malloc-conf=background_thread:true
          # Two-option combinations with --disable-libdl
          - --disable-libdl --enable-opt-safety-checks
          - --disable-libdl --with-lg-page=16
          - --disable-libdl --enable-prof --enable-prof-frameptr
          - --disable-libdl --with-malloc-conf=tcache:false
          - --disable-libdl --with-malloc-conf=dss:primary
          - --disable-libdl --with-malloc-conf=percpu_arena:percpu
          - --disable-libdl --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-opt-safety-checks
          - --enable-opt-safety-checks --with-lg-page=16
          - --enable-opt-safety-checks --enable-prof --enable-prof-frameptr
          - --enable-opt-safety-checks --with-malloc-conf=tcache:false
          - --enable-opt-safety-checks --with-malloc-conf=dss:primary
          - --enable-opt-safety-checks --with-malloc-conf=percpu_arena:percpu
          - --enable-opt-safety-checks --with-malloc-conf=background_thread:true
          # Two-option combinations with --with-lg-page=16
          - --with-lg-page=16 --enable-prof --enable-prof-frameptr
          - --with-lg-page=16 --with-malloc-conf=tcache:false
          - --with-lg-page=16 --with-malloc-conf=dss:primary
          - --with-lg-page=16 --with-malloc-conf=percpu_arena:percpu
          - --with-lg-page=16 --with-malloc-conf=background_thread:true
          # Two-option combinations with --enable-prof --enable-prof-frameptr
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=tcache:false
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=dss:primary
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=percpu_arena:percpu
          - --enable-prof --enable-prof-frameptr --with-malloc-conf=background_thread:true
          # Multiple malloc-conf options
          - --with-malloc-conf=tcache:false,dss:primary
          - --with-malloc-conf=tcache:false,percpu_arena:percpu
          - --with-malloc-conf=tcache:false,background_thread:true
          - --with-malloc-conf=dss:primary,percpu_arena:percpu
          - --with-malloc-conf=dss:primary,background_thread:true
          - --with-malloc-conf=percpu_arena:percpu,background_thread:true
        exclude:
          # Clang doesn't need all the same combinations, reduce matrix
          - compiler: clang
            flags: --enable-debug --disable-stats
          - compiler: clang
            flags: --enable-debug --disable-libdl
          - compiler: clang
            flags: --enable-debug --enable-opt-safety-checks
          - compiler: clang
            flags: --enable-debug --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-debug --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-prof --disable-stats
          - compiler: clang
            flags: --enable-prof --disable-libdl
          - compiler: clang
            flags: --enable-prof --enable-opt-safety-checks
          - compiler: clang
            flags: --enable-prof --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-prof --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-stats --disable-libdl
          - compiler: clang
            flags: --disable-stats --enable-opt-safety-checks
          - compiler: clang
            flags: --disable-stats --with-lg-page=16
          - compiler: clang
            flags: --disable-stats --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-stats --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --disable-libdl --enable-opt-safety-checks
          - compiler: clang
            flags: --disable-libdl --with-lg-page=16
          - compiler: clang
            flags: --disable-libdl --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --disable-libdl --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --enable-opt-safety-checks --with-lg-page=16
          - compiler: clang
            flags: --enable-opt-safety-checks --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-opt-safety-checks --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --with-lg-page=16 --enable-prof --enable-prof-frameptr
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --with-lg-page=16 --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=tcache:false
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=dss:primary
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=percpu_arena:percpu
          - compiler: clang
            flags: --enable-prof --enable-prof-frameptr --with-malloc-conf=background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,dss:primary
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,percpu_arena:percpu
          - compiler: clang
            flags: --with-malloc-conf=tcache:false,background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=dss:primary,percpu_arena:percpu
          - compiler: clang
            flags: --with-malloc-conf=dss:primary,background_thread:true
          - compiler: clang
            flags: --with-malloc-conf=percpu_arena:percpu,background_thread:true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf

      - name: Configure
        env:
          CC: ${{ matrix.compiler == 'clang' && 'clang' || 'gcc' }}
          CXX: ${{ matrix.compiler == 'clang' && 'clang++' || 'g++' }}
          EXTRA_CFLAGS: ${{ matrix.compiler == 'clang' && '-Werror -Wno-array-bounds -Wno-unknown-warning-option -Wno-ignored-attributes' || '-Werror -Wno-array-bounds' }}
        run: |
          autoconf
          ./configure ${{ matrix.flags }}

      - name: Build
        run: make -j$(nproc)

      - name: Build tests
        run: make -j$(nproc) tests

      - name: Run tests
        run: make check

  # Level 2: 32-bit builds (after Linux succeeds)
  linux-32bit:
    name: Linux 32-bit - gcc ${{ matrix.name }}
    runs-on: ubuntu-24.04
    needs: basic-platforms
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            flags: ''
          - name: debug
            flags: --enable-debug
          - name: prof
            flags: --enable-prof
          - name: disable-stats
            flags: --disable-stats
          - name: disable-libdl
            flags: --disable-libdl
          - name: opt-safety-checks
            flags: --enable-opt-safety-checks
          - name: lg-page-16
            flags: --with-lg-page=16
          - name: prof-frameptr
            flags: --enable-prof --enable-prof-frameptr
          - name: tcache-false
            flags: --with-malloc-conf=tcache:false
          - name: dss-primary
            flags: --with-malloc-conf=dss:primary
          - name: percpu-arena
            flags: --with-malloc-conf=percpu_arena:percpu
          - name: background-thread
            flags: --with-malloc-conf=background_thread:true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf gcc-multilib g++-multilib

      - name: Configure
        env:
          EXTRA_CFLAGS: '-Werror -Wno-array-bounds'
        run: |
          autoconf
          ./configure CC="gcc -m32" CXX="g++ -m32" ${{ matrix.flags }}

      - name: Build
        run: make -j$(nproc)

      - name: Build tests
        run: make -j$(nproc) tests

      - name: Run tests
        run: make check

  # Special builds
  special-builds:
    name: ${{ matrix.name }}
    runs-on: ubuntu-24.04
    needs: basic-platforms
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Development build
            flags: --enable-debug --disable-cache-oblivious --enable-stats --enable-log --enable-prof
          - name: Experimental smallocx
            flags: --enable-debug --enable-experimental-smallocx --enable-stats --enable-prof

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf

      - name: Configure
        env:
          CC: gcc
          CXX: g++
          EXTRA_CFLAGS: '-Werror -Wno-array-bounds'
        run: |
          autoconf
          ./configure ${{ matrix.flags }}

      - name: Build
        run: make -j$(nproc)

      - name: Build tests
        run: make -j$(nproc) tests

      - name: Run tests
        run: make check